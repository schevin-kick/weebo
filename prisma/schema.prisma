generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BusinessOwner {
  id                    String            @id @default(cuid())
  lineUserId            String            @unique
  displayName           String
  pictureUrl            String?
  email                 String?           @unique
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Subscription fields
  stripeCustomerId      String?           @unique
  stripeSubscriptionId  String?           @unique
  subscriptionStatus    String?           // 'trialing', 'active', 'incomplete', 'incomplete_expired', 'past_due', 'canceled', 'unpaid', 'paused'
  trialStartsAt         DateTime?
  trialEndsAt           DateTime?
  currentPeriodEnd      DateTime?
  canceledAt            DateTime?

  businesses            Business[]
  pageTemplates         PageTemplate[]
  serviceTemplates      ServiceTemplate[]

  @@index([lineUserId])
  @@index([email])
  @@index([stripeCustomerId])
  @@index([subscriptionStatus])
}

model Business {
  id                     String                @id @default(cuid())
  ownerId                String
  businessName           String
  logoUrl                String?
  businessHours          Json
  defaultDuration        Int
  appointmentOnly        Boolean               @default(false)
  requiresApproval       Boolean               @default(false)
  qrCodeUrl              String?
  lineDeepLink           String                @unique
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  address                String
  email                  String?
  phone                  String?
  website                String?
  enableReminders        Boolean               @default(true)
  lineChannelAccessToken String?
  messageTemplates       Json                  @default("{\"reminder\": {\"body\": \"Don't forget your appointment tomorrow!\", \"header\": \"Reminder: Upcoming Appointment\"}, \"cancellation\": {\"body\": \"Your booking has been cancelled. We hope to see you again soon!\", \"header\": \"Booking Cancelled\"}, \"confirmation\": {\"body\": \"We look forward to seeing you!\", \"header\": \"Your booking is confirmed!\"}}")
  reminderHoursBefore    Int                   @default(24)
  lineBotBasicId         String?
  messagingMode          String?               @default("shared")
  webhookConfigured      Boolean               @default(false)
  webhookUrl             String?
  lineWebhookVerified    Boolean               @default(false)
  webhookAcknowledged    Boolean               @default(false)
  heroBackgroundColor    String?               @default("#FFFFFF")
  notificationsEnabled   Boolean               @default(true)
  bookings               Booking[]
  owner                  BusinessOwner         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  closedDates            ClosedDate[]
  pages                  Page[]
  services               Service[]
  staff                  Staff[]
  customerBotMappings    CustomerBotMapping[]

  @@index([ownerId])
  @@index([lineDeepLink])
  @@index([ownerId, isActive])
}

model Customer {
  id                  String               @id @default(cuid())
  lineUserId          String               @unique
  displayName         String
  pictureUrl          String?
  language            String?
  statusMessage       String?
  lastActiveAt        DateTime             @default(now())
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  bookings            Booking[]
  customerBotMappings CustomerBotMapping[]

  @@index([lineUserId])
  @@index([lastActiveAt])
}

model Service {
  id          String    @id @default(cuid())
  businessId  String
  name        String
  description String?
  duration    Int
  price       Float?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  bookings    Booking[]
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([businessId, order])
  @@index([businessId, isActive])
}

model Staff {
  id           String    @id @default(cuid())
  businessId   String
  name         String
  specialty    String?
  description  String?
  photoUrl     String?
  availability Json
  order        Int       @default(0)
  isActive     Boolean   @default(true)
  bookings     Booking[]
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([businessId, order])
  @@index([businessId, isActive])
}

model Page {
  id         String   @id @default(cuid())
  businessId String
  type       String
  title      String
  order      Int
  components Json
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, order])
}

model ClosedDate {
  id            String   @id @default(cuid())
  businessId    String
  startDateTime DateTime
  endDateTime   DateTime
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, startDateTime])
}

model Booking {
  id                 String           @id @default(cuid())
  businessId         String
  customerId         String
  serviceId          String?
  staffId            String?
  dateTime           DateTime
  duration           Int
  status             String
  responses          Json
  reminderSent       Boolean          @default(false)
  confirmationSent   Boolean          @default(false)
  notes              String?
  noShow             Boolean          @default(false)
  cancelledAt        DateTime?
  cancelledBy        String?
  cancellationReason String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  business           Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer           Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  service            Service?         @relation(fields: [serviceId], references: [id])
  staff              Staff?           @relation(fields: [staffId], references: [id])
  messages           BookingMessage[]

  @@index([businessId, dateTime])
  @@index([customerId])
  @@index([businessId, status])
  @@index([dateTime, reminderSent])
  @@index([staffId])
}

model BookingMessage {
  id             String   @id @default(cuid())
  bookingId      String
  messageType    String
  sentAt         DateTime @default(now())
  deliveryStatus String
  messageContent Json
  booking        Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([bookingId, messageType])
}

model ServiceTemplate {
  id          String        @id @default(cuid())
  ownerId     String
  name        String
  description String?
  duration    Int
  price       Float?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  owner       BusinessOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
}

model PageTemplate {
  id         String        @id @default(cuid())
  ownerId    String
  type       String
  title      String
  components Json
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  owner      BusinessOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
}

model CustomerBotMapping {
  id                String   @id @default(cuid())
  customerId        String
  businessId        String
  liffUserId        String
  businessBotUserId String
  linkedAt          DateTime @default(now())
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([customerId, businessId])
  @@index([liffUserId])
  @@index([businessBotUserId])
}
